<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Taverne</title>
  <link href="https://fonts.googleapis.com/css2?family=Pixelify+Sans:wght@400..700&display=swap" rel="stylesheet">
  
  <style>
    /* --- RÉGLAGES GLOBAUX --- */
    *, *::before, *::after { box-sizing: border-box; }
    html, body { margin: 0; height: 100%; background: #1a1a1a; overflow: hidden; }

    body {
      display: flex; justify-content: center; align-items: center;
      font-family: "Pixelify Sans", monospace; color: #3e2723;
    }

    /* --- CONTENEUR DE JEU --- */
    .game-wrapper {
      aspect-ratio: 9 / 16;
      width: min(60vh, 90vw);
      display: flex; flex-direction: column;
      overflow: hidden; position: relative;
      background: #000; border: 2px solid #333;
    }

    .scanlines {
      position: absolute; inset: 0;
      background: linear-gradient(to bottom, transparent, transparent 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
      background-size: 100% 4px; pointer-events: none; z-index: 50;
    }

    /* --- BOUTONS DE CONTRÔLE (HOME & MUTE) --- */
    .top-controls {
      position: absolute; top: 15px; right: 15px;
      display: flex; flex-direction: column; gap: 10px; z-index: 100;
    }

    .btn-pixel {
      width: 44px; height: 44px;
      background-color: #fff1e0; border: 3px solid #3e2723;
      border-radius: 50%; cursor: pointer;
      display: flex; justify-content: center; align-items: center;
      box-shadow: 0 4px 0 rgba(0,0,0,0.2);
    }
    .btn-pixel:active { transform: translateY(2px); box-shadow: 0 2px 0 rgba(0,0,0,0.1); }
    .btn-pixel img { width: 24px; height: auto; image-rendering: pixelated; pointer-events: none; }

    /* --- SCÈNE --- */
    .scene { flex: 1; position: relative; overflow: hidden; background-color: #333; image-rendering: pixelated; }

    .bar-bg {
      position: absolute; inset: 0;
      background: url('Images/bar_large.png') center bottom / cover no-repeat; 
      z-index: 1;
    }

    .barman {
      position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%);
      max-height: 85%; max-width: 90%; z-index: 2; image-rendering: pixelated;
      animation: idle 2s infinite ease-in-out;
    }

    @keyframes idle {
      0%, 100% { transform: translateX(-50%) translateY(0); }
      50% { transform: translateX(-50%) translateY(4px); }
    }

    /* --- BOÎTE DE DIALOGUE --- */
    .dialogue-box {
      width: 100%; background-color: #fff1e0; border-top: 4px solid #3e2723;
      padding: 20px; position: relative; cursor: pointer; z-index: 10;
      animation: slideUp 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28);
    }

    @keyframes slideUp {
      from { transform: translateY(100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .text { font-size: 1.4rem; line-height: 1.4; min-height: 4.2em; color: #3e2723; }

    /* --- CHOIX --- */
    .choices { margin-top: 10px; border-top: 2px dashed rgba(62, 39, 35, 0.3); padding-top: 5px; }

    .choice-btn {
      display: block; width: 100%; text-align: left; padding: 8px 0;
      background: none; border: none; cursor: pointer;
      font-family: inherit; font-size: 1.2rem; color: #5d4037; transition: all 0.2s;
    }
    .choice-btn:hover { color: #d32f2f; padding-left: 10px; font-weight: bold; }
    .choice-btn::before { content: "➤ "; opacity: 0; transition: opacity 0.2s; }
    .choice-btn:hover::before { opacity: 1; }

    .arrow {
      position: absolute; bottom: 10px; right: 15px; font-size: 24px;
      color: #d32f2f; display: none; animation: bounce 1s infinite;
    }

    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(3px); } }
  </style>
</head>

<body>
  <audio id="bgMusic" src="/Musique/taverne.wav" loop></audio>
  <audio id="clickSound" src="/Sons/pop.mp3"></audio>

  <div class="game-wrapper">
    <div class="scanlines"></div>

    <div class="top-controls">
      <button class="btn-pixel" id="homeBtn">
        <img src="Images/home.png" alt="Home">
      </button>
      <button class="btn-pixel" id="muteBtn">
        <img src="Images/unmute.png" id="muteIcon" alt="Mute">
      </button>
    </div>

    <div class="scene">
      <div class="bar-bg"></div>
      <img class="barman" src="Images/big_barman.png" alt="Barman">
    </div>

    <div class="dialogue-box" id="dialogueBox">
      <div class="text" id="text"></div>
      <div class="choices" id="choices"></div>
      <div class="arrow" id="arrow">▼</div>
    </div>
  </div>

  <script>
    const routes = {
      intro: [
        "Bienvenue à toi jeune flibustier !",
        "Qu'est-ce qui t'amène ici ?",
        "__CHOICES__"
      ],
      nom: [
        "Encore un qui vient me parler de Barbe d'Or...",
        "Lui et son équipage venaient souvent mais ils n'étaient pas très bavards.",
        "Quand il décidait de nous parler, il n'y en avait que pour son bateau...",
        "À part ça tu veux pas boire quel-",
        "Déjà repartit..."
      ],
      soif: [
        "Tu as soif ? Ça tombe bien, c'est un bar ici.",
        "Assieds-toi, je vais te servir.",
        "Tiens, je te mets la cuvée maison!"
      ],
      vieuxRoux: [
        "Le vieux roux, hein...",
        "On ne le vois plus trop ces derniers temps.",
        "Apparement il traîne vers le Sud.",
      ]
    };

    let currentRoute = "intro";
    let dialogues = routes[currentRoute];
    let index = 0;
    let charIndex = 0;
    let isTyping = false;
    let intervalId = null;
    let musicStarted = false;

    const textEl = document.getElementById("text");
    const arrowEl = document.getElementById("arrow");
    const dialogueBox = document.getElementById("dialogueBox");
    const choicesEl = document.getElementById("choices");
    const music = document.getElementById("bgMusic");
    const clickSfx = document.getElementById("clickSound");
    const muteBtn = document.getElementById("muteBtn");
    const muteIcon = document.getElementById("muteIcon");
    const homeBtn = document.getElementById("homeBtn");

    function playClick() {
      clickSfx.currentTime = 0;
      clickSfx.play().catch(() => {});
    }

    function startMusic() {
      if (!musicStarted) {
        music.volume = 0.3;
        music.play().catch(() => {});
        musicStarted = true;
      }
    }

    function typeText() {
      isTyping = true;
      arrowEl.style.display = "none";
      choicesEl.innerHTML = "";
      textEl.textContent = "";
      charIndex = 0;

      const currentText = dialogues[index];

      if (currentText === "__CHOICES__") {
        isTyping = false;
        showChoices();
        return;
      }

      intervalId = setInterval(() => {
        textEl.textContent += currentText[charIndex];
        charIndex++;

        if (charIndex >= currentText.length) {
          clearInterval(intervalId);
          isTyping = false;
          arrowEl.style.display = "block"; 
        }
      }, 30);
    }

    function showChoices() {
      textEl.textContent = routes.intro[1]; 
      arrowEl.style.display = "none";

      const opts = [
        { label: "En savoir plus sur Barbe d'Or", route: "nom" },
        { label: "J'ai soif", route: "soif" },
        { label: "Je cherche le vieux roux", route: "vieuxRoux" }
      ];

      opts.forEach(opt => {
        const btn = document.createElement("button");
        btn.className = "choice-btn";
        btn.textContent = opt.label;
        btn.onclick = (e) => {
          e.stopPropagation();
          playClick();
          currentRoute = opt.route;
          dialogues = routes[currentRoute];
          index = 0;
          typeText();
        };
        choicesEl.appendChild(btn);
      });
    }

    function nextDialogue() {
      if (isTyping) {
          clearInterval(intervalId);
          textEl.textContent = dialogues[index];
          isTyping = false;
          arrowEl.style.display = "block";
          return;
      }
      index++;
      if (index < dialogues.length) {
        typeText();
      } else {
        returnToChoices();
      }
    }

    function returnToChoices() {
      currentRoute = "intro";
      dialogues = routes[currentRoute];
      index = dialogues.length - 1; 
      typeText();
    }

    /* --- LOGIQUE DES BOUTONS --- */
    muteBtn.onclick = (e) => {
      e.stopPropagation();
      playClick();
      music.muted = !music.muted;
      // ICI : On a enlevé le / devant Images
      muteIcon.src = music.muted ? "Images/mute.png" : "Images/unmute.png";
    };

    homeBtn.onclick = (e) => {
      e.stopPropagation();
      playClick();
      setTimeout(() => { location.href = 'accueil.html'; }, 150);
    };

    dialogueBox.addEventListener("click", () => {
      startMusic();
      if (choicesEl.children.length === 0) {
        playClick();
        nextDialogue();
      }
    });

    typeText();
  </script>
</body>

</html>

